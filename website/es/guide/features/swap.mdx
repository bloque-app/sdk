
# Swap

Aprende cómo realizar intercambios de activos usando el SDK de Bloque.

## Descripción General

El módulo swap permite consultar tasas de cambio y realizar intercambios de activos entre diferentes medios y monedas soportadas.

## Realizando una Consulta de Tasas

```typescript
import { SDK } from '@bloque/sdk';

const bloque = new SDK({
  origin: 'your-origin',
  auth: {
    type: 'apiKey',
    apiKey: process.env.BLOQUE_API_KEY!,
  },
  mode: 'production',
});

const userSession = await bloque.connect('user-alias');

const result = await userSession.swap.findRates({
  fromAsset: 'COP/2',
  toAsset: 'DUSD/6',
  fromMediums: ['bancolombia', 'pse'], // required
  toMediums: ['kusama'], // required
  amountSrc: '50000000', // 500000.00 COP (scaled by 2 decimals)
  sort: 'asc', // optional, default: 'asc'
  sortBy: 'rate', // optional, default: 'rate'
});
console.log('Swap rates result:', result);
```

## Parámetros

### FindRatesParams

| Campo         | Tipo         | Requerido | Descripción                                                                 |
|-------------- |--------------|-----------|-----------------------------------------------------------------------------|
| `fromAsset`   | `string`     | Sí        | Activo origen con precisión (ej: "COP/2")                                  |
| `toAsset`     | `string`     | Sí        | Activo destino con precisión (ej: "DUSD/6")                                |
| `fromMediums` | `string[]`   | Sí        | Medios de pago origen (ej: `["bancolombia"]`)                              |
| `toMediums`   | `string[]`   | Sí        | Medios de pago destino (ej: `["kusama"]`)                                  |
| `amountSrc`   | `string`     | Opcional  | Monto origen como string bigint (escalar según precisión)                    |
| `amountDst`   | `string`     | Opcional  | Monto destino como string bigint (escalar según precisión)                   |
| `sort`        | `'asc'|'desc'`| Opcional | Orden de resultados (por defecto 'asc')                                     |
| `sortBy`      | `'rate'|'at'` | Opcional | Campo de ordenamiento ('rate' por defecto)                                  |

## Respuesta

### FindRatesResult

```typescript
interface FindRatesResult {
  rates: SwapRate[];
}
```

### SwapRate

```typescript
interface SwapRate {
  id: string;
  sig: string;
  swapSig: string;
  maker: string;
  edge: [string, string];
  fee: Fee;
  at: string;
  until: string;
  fromMediums: string[];
  toMediums: string[];
  rate: [number, number];
  ratio: number;
  fromLimits: [string, string];
  toLimits: [string, string];
  createdAt: string;
  updatedAt: string;
}
```

### Fee

```typescript
interface Fee {
  at: number;
  value: number;
  formula: string;
  components: FeeComponent[];
}
```

### FeeComponent

```typescript
interface FeeComponent {
  at: number;
  name: string;
  type: 'percentage' | 'rate' | 'fixed';
  value: number | string;
  percentage?: number;
  pair?: string;
  amount?: number;
}
```

## Ejemplo Completo de Flujo

```typescript
import { SwapClient } from '@bloque/swap';

const client = new SwapClient({ /* configuración */ });

async function consultarTasas() {
  const resultado = await client.findRates({
    fromAsset: 'COP/2',
    toAsset: 'DUSD/6',
    fromMediums: ['bancolombia'],
    toMediums: ['kusama'],
    amountSrc: '50000000',
  });

  if (resultado.rates.length > 0) {
    const mejorTasa = resultado.rates[0];
    console.log('Ratio:', mejorTasa.ratio);
    console.log('Fee:', mejorTasa.fee.value);
  } else {
    console.log('No se encontraron tasas disponibles');
  }
}

consultarTasas();
```

## Mejores Prácticas

1. Valida los parámetros de entrada antes de consultar tasas.
2. Usa los campos de límites (`fromLimits`, `toLimits`) para validar montos permitidos.
3. Maneja correctamente los posibles errores de red o de la API.
4. Consulta tasas justo antes de realizar una operación para evitar expiraciones.
5. Revisa el campo `until` para saber hasta cuándo es válida la tasa.

## Próximos Pasos

## Listar Bancos PSE

Puedes obtener la lista de bancos disponibles para pagos PSE (Pagos Seguros en Línea) junto con sus códigos:

```typescript
const pseBanks = await userSession.swap.pse.banks();
for (const bank of pseBanks.banks) {
  console.log(`${bank.code}: ${bank.name}`);
}
```

### Tipo Bank

```typescript
interface Bank {
  code: string; // Código del banco para PSE
  name: string; // Nombre del banco
}
```

Esto es útil para mostrar la lista de bancos al usuario al iniciar swaps o pagos vía PSE.

## Pagos PSE

El SDK permite realizar pagos a través de PSE (Pagos Seguros en Línea) en un flujo de dos pasos:
1. Crear una intención de pago (top-up)
2. Iniciar el pago PSE con los datos del pagador

### Paso 1: Crear Top-Up

Primero, crea una intención de pago con el monto y la moneda:

```typescript
const topUp = await userSession.swap.pse.createTopUp({
  amount: '50000000', // 500,000.00 COP (escalado por 2 decimales)
  currency: 'DUSD/6',
  successUrl: 'https://tu-app.com/pago/exitoso',
  webhookUrl: 'https://tu-app.com/webhooks/pago',
});

console.log('Payment URN:', topUp.payment.urn);
console.log('Payment URL:', topUp.payment.url);
```

#### Parámetros CreateTopUpParams

| Campo        | Tipo       | Requerido | Descripción                                      |
|--------------|------------|-----------|--------------------------------------------------|
| `amount`     | `string`   | Sí        | Monto del pago (escalado por precisión)          |
| `currency`   | `Currency` | Sí        | Moneda con precisión (ej: "DUSD/6")              |
| `successUrl` | `string`   | No        | URL de redirección en pago exitoso               |
| `webhookUrl` | `string`   | No        | URL para notificaciones de pago                  |

### Paso 2: Iniciar Pago PSE

Con el URN del pago, inicia el flujo PSE proporcionando los datos del pagador:

```typescript
const result = await userSession.swap.pse.initiatePayment({
  paymentUrn: topUp.payment.urn,
  payee: {
    name: 'Juan Pérez García',
    email: 'juan.perez@example.com',
    idType: 'CC',
    idNumber: '1055228746',
  },
  personType: 'natural',
  bankCode: '1', // Código del banco obtenido de pse.banks()
});

// Redirigir al usuario a PSE
window.location.href = result.checkoutUrl;
```

#### Parámetros InitiatePsePaymentParams

| Campo        | Tipo         | Requerido | Descripción                                    |
|--------------|--------------|-----------|------------------------------------------------|
| `paymentUrn` | `string`     | Sí        | URN del pago obtenido de createTopUp           |
| `payee`      | `PsePayee`   | Sí        | Información del pagador                        |
| `personType` | `PersonType` | Sí        | Tipo de persona: "natural" o "juridica"        |
| `bankCode`   | `string`     | Sí        | Código del banco (de pse.banks())              |

#### Tipo PsePayee

```typescript
interface PsePayee {
  name: string;     // Nombre completo
  email: string;    // Correo electrónico
  idType: string;   // Tipo de documento (CC, NIT, CE, etc.)
  idNumber: string; // Número de documento
}
```

#### Respuesta InitiatePsePaymentResult

```typescript
interface InitiatePsePaymentResult {
  paymentId: string;    // ID del pago
  status: string;       // Estado del pago
  message: string;      // Mensaje de estado
  amount: string;       // Monto del pago
  currency: Currency;   // Moneda
  checkoutUrl: string;  // URL de PSE para redirigir al usuario
  orderId: string;      // ID de la orden
  orderStatus: string;  // Estado de la orden
  createdAt: string;    // Fecha de creación
}
```

### Ejemplo Completo de Flujo PSE

```typescript
import { SDK } from '@bloque/sdk';

const bloque = new SDK({
  origin: 'your-origin',
  auth: {
    type: 'apiKey',
    apiKey: process.env.BLOQUE_API_KEY!,
  },
  mode: 'production',
});

async function realizarPagoPSE() {
  const userSession = await bloque.connect('user-alias');

  // 1. Obtener lista de bancos
  const { banks } = await userSession.swap.pse.banks();
  console.log('Bancos disponibles:', banks);

  // 2. Crear intención de pago
  const topUp = await userSession.swap.pse.createTopUp({
    amount: '50000000',
    currency: 'DUSD/6',
    successUrl: 'https://tu-app.com/pago/exitoso',
    webhookUrl: 'https://tu-app.com/webhooks/pago',
  });

  // 3. Iniciar pago PSE con datos del usuario
  const result = await userSession.swap.pse.initiatePayment({
    paymentUrn: topUp.payment.urn,
    payee: {
      name: 'Juan Pérez García',
      email: 'juan.perez@example.com',
      idType: 'CC',
      idNumber: '1055228746',
    },
    personType: 'natural',
    bankCode: banks[0].code, // Banco seleccionado por el usuario
  });

  // 4. Redirigir al usuario a PSE
  console.log('Redirigiendo a:', result.checkoutUrl);
  window.location.href = result.checkoutUrl;
}

realizarPagoPSE();
```

- [Guía de Cuentas](/sdk/guide/accounts/overview) - Crea y gestiona cuentas para operar swaps
- [Guía de Organizaciones](/sdk/guide/features/organizations) - Administra entidades que pueden realizar swaps
