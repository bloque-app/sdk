# M√°quinas de Estado

Aprende sobre las m√°quinas de estado que gestionan el ciclo de vida de las entidades en el SDK de Bloque.

## Descripci√≥n General

El SDK de Bloque utiliza m√°quinas de estado bien definidas para gestionar el ciclo de vida de todas las entidades principales. Comprender estos estados y sus transiciones es esencial para construir integraciones robustas.

## M√°quinas de Estado Principales

### üìã Cuentas
Las cuentas gestionan los fondos de los usuarios y siguen un ciclo de vida bien definido desde la creaci√≥n hasta la eliminaci√≥n.

**Estados clave:**
- `creation_in_progress` ‚Üí `active` ‚Üí `disabled`/`frozen`/`deleted`
- Maneja errores: `creation_failed`

**Documentaci√≥n completa:** [Cuentas Virtuales](/sdk/guide/accounts/virtual) | [Tarjetas Virtuales](/sdk/guide/accounts/cards)

### üí∏ Transferencias
Las transferencias mueven fondos entre cuentas y se procesan de forma as√≠ncrona.

**Estados clave:**
- `queued` ‚Üí `processing` ‚Üí `completed`/`failed`

**Documentaci√≥n completa:** [Transferencias](/sdk/guide/accounts/transfers)

### üè¢ Organizaciones
Las organizaciones representan entidades legales (empresas o individuos) con requisitos de cumplimiento normativo.

**Estados clave:**
- `awaiting_compliance_verification` ‚Üí `active` ‚Üí `suspended`/`closed`

**Documentaci√≥n completa:** [Organizaciones](/sdk/guide/features/organizations)

### üîç KYC/Compliance
Gestiona la verificaci√≥n de identidad y el proceso de cumplimiento normativo.

**Estados clave:**
- `awaiting_compliance_verification` ‚Üí `approved`/`rejected`

**Documentaci√≥n completa:** [Cumplimiento Normativo & KYC](/sdk/guide/features/compliance)

### üîÑ Swap
Gestiona √≥rdenes de intercambio de activos entre diferentes medios y monedas.

**Estados clave:**
- √ìrdenes: `pending` ‚Üí `in_progress` ‚Üí `completed`/`failed`
- Ejecuci√≥n: `pending` ‚Üí `running` ‚Üí `completed`/`failed`

**Documentaci√≥n completa:** [Swap](/sdk/guide/features/swap)

## Patrones Comunes

### üîÑ Estados Transitorios vs Finales

**Estados Transitorios:**
- `creation_in_progress`, `processing`, `pending`, `awaiting_*`
- Requieren acci√≥n o tiempo para cambiar
- Generalmente tienen timeouts asociados

**Estados Finales:**
- `completed`, `failed`, `deleted`, `closed`, `approved`, `rejected`
- No cambian sin intervenci√≥n externa
- Representan el resultado de un proceso

### ‚è±Ô∏è Patr√≥n de Sondeo (Polling)

Para estados que se resuelven de forma as√≠ncrona:

```typescript
async function waitForCompletion(getStatus: () => Promise<{status: string}>) {
  let attempts = 0;
  const maxAttempts = 30; // 30 intentos
  
  while (attempts < maxAttempts) {
    const result = await getStatus();
    
    if (['completed', 'failed', 'approved', 'rejected'].includes(result.status)) {
      return result; // Estado final alcanzado
    }
    
    // Esperar 2 segundos entre intentos
    await new Promise(resolve => setTimeout(resolve, 2000));
    attempts++;
  }
  
  throw new Error('Timeout esperando completaci√≥n');
}
```

### ü™ù Patr√≥n de Webhooks

Para notificaciones en tiempo real de cambios de estado:

```typescript
// Configurar URL de webhook al crear entidades
const account = await session.accounts.virtual.create({
  firstName: 'Juan',
  lastName: 'P√©rez',
  webhookUrl: 'https://api.example.com/webhooks/account-status'
});

// Manejar cambios de estado
app.post('/webhooks/account-status', (req, res) => {
  const { type, data } = req.body;
  
  if (type === 'account.status_changed') {
    console.log(`Cuenta ${data.urn} cambi√≥ a: ${data.status}`);
    
    // Actualizar base de datos local
    updateLocalAccount(data.urn, { status: data.status });
  }
  
  res.status(200).send('OK');
});
```

## Manejo de Errores por Estado

### Estados de Error Comunes

| Error | Estados Asociados | Soluci√≥n |
|-------|-------------------|-----------|
| `creation_failed` | Cuentas, Tarjetas | Verificar datos, reintentar |
| `failed` | Transferencias, Swap | Verificar fondos, validar par√°metros |
| `rejected` | KYC, Organizaciones | Contactar soporte, revisar documentaci√≥n |
| `suspended` | Organizaciones, Cuentas | Resolver problema de cumplimiento |

### Estrategias de Recuperaci√≥n

```typescript
async function handleFailedTransfer(sourceUrn: string, destinationUrn: string) {
  // Verificar que las cuentas sigan existiendo y activas
  const source = await bloque.accounts.get(sourceUrn);
  const dest = await bloque.accounts.get(destinationUrn);

  if (source.status !== 'active' || dest.status !== 'active') {
    throw new Error('La cuenta origen o destino no est√° activa.');
  }

  // Verificar saldo antes de reintentar
  const balances = await bloque.accounts.balance(sourceUrn);
  if (!balances['DUSD/6'] || balances['DUSD/6'].current === '0') {
    throw new Error('Fondos insuficientes. Verifica tu saldo.');
  }
}
```

## Mejores Pr√°cticas

### 1. **Verificar Estados Antes de Operaciones**

```typescript
// ‚úÖ Bueno: verificar estado antes de transferir
const account = await session.accounts.get(accountUrn);
if (account.status !== 'active') {
  throw new Error('La cuenta debe estar activa para transferir');
}

await session.accounts.transfer({
  sourceUrn: accountUrn,
  destinationUrn: destUrn,
  amount: '1000000',
  asset: 'DUSD/6'
});
```

### 2. **Manejar Estados Transitorios con Timeouts**

```typescript
async function waitForActive(accountUrn: string, timeoutMs = 30000) {
  const startTime = Date.now();
  
  while (Date.now() - startTime < timeoutMs) {
    const account = await session.accounts.get(accountUrn);
    
    if (account.status === 'active') {
      return account;
    }
    
    if (account.status === 'creation_failed') {
      throw new Error('Fall√≥ la creaci√≥n de la cuenta');
    }
    
    await new Promise(resolve => setTimeout(resolve, 1000));
  }
  
  throw new Error('Timeout esperando activaci√≥n de la cuenta');
}
```

### 3. **Implementar Reintentos con Backoff Exponencial**

```typescript
async function retryOperation<T>(
  operation: () => Promise<T>,
  maxRetries = 3,
  baseDelay = 1000
): Promise<T> {
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      return await operation();
    } catch (error) {
      if (attempt === maxRetries) throw error;
      
      const delay = baseDelay * Math.pow(2, attempt - 1);
      await new Promise(resolve => setTimeout(resolve, delay));
    }
  }
  
  throw new Error('M√°ximo de reintentos excedido');
}
```

## Referencias R√°pidas

### Resumen de Estados

| Entidad | Estados Clave | Tiempo de Resoluci√≥n T√≠pico |
|---------|---------------|---------------------------|
| Cuentas | 6 estados | 1-30 segundos |
| Transferencias | 4 estados | 5-60 segundos |
| Organizaciones | 4 estados | 1-3 d√≠as (manual) |
| KYC | 3 estados | 5-30 minutos |
| Swap | 5 estados (√≥rdenes) | 1-10 minutos |

### Diagramas de Flujo

Para visualizar las transiciones de estado, consulta las gu√≠as espec√≠ficas de entidades donde encontrar√°s tablas de transici√≥n detalladas y ejemplos pr√°cticos.

## Pr√≥ximos Pasos

- [Gu√≠a de Cuentas](/sdk/guide/accounts/overview) - Para entender los estados de las cuentas
- [Gu√≠a de Transferencias](/sdk/guide/accounts/transfers) - Para gestionar los estados de transferencias
- [Gu√≠a de Organizaciones](/sdk/guide/features/organizations) - Para los estados de cumplimiento
- [Gu√≠a de Swap](/sdk/guide/features/swap) - Para los estados de swap
